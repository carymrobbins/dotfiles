#!/bin/sh

set -e

# Note we use --set "Broadcast RGB" "Full" to avoid the washed out colors
# over HDMI; see https://askubuntu.com/questions/621964/colors-on-display-are-washed-out
output=$(
xrandr \
  --output HDMI-2 --off \
  --output DP-1 --off \
  --output eDP-1 --primary --mode 1920x1080 --pos 1920x1080 --rotate normal \
  --output HDMI-1 --mode 1920x1080 --pos 0x504 --rotate normal \
                  --set "Broadcast RGB" "Full" \
  --output DP-2 --mode 1920x1080 --pos 1920x0 --rotate normal \
                --set "Broadcast RGB" "Full" \
  2>&1
)
if [ $? -ne 0 ]; then
  notify-send "$output"
  >&2 echo "$output"
  exit 1
fi

xmonad --restart

# Poll/sleep until 3 monitors detected, stop trying after 5 seconds.
# This is so stalonetray can be positioned properly for the new layout.
elapsed=0
timeout=5
while [ "$elapsed" -lt "$timeout" ]; do
  if [ "$(xrandr | fgrep '*+' | wc -l)" -eq 3 ]; then
    break
  fi
  sleep 1
  ((++elapsed))
done
systemctl --user restart stalonetray

# Reload x settings to fix wallpaper and screen refreshing
reload-x-settings
