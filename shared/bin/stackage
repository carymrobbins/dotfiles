#!/bin/bash

if [ "$(uname)" = "Darwin" ]; then
  OPEN=open
else
  OPEN=xdg-open
fi

if [ -f stack.yaml ]; then
  stack_yaml=stack.yaml
elif [ -f ~/.stack/global-project/stack.yaml ]; then
  stack_yaml=~/.stack/global-project/stack.yaml
else
  >&2 echo "No local or global stack.yaml found"
  exit 1
fi

find_resolver() {
  grep '^resolver' "$1" | cut -d: -f2 | xargs
}

resolver=$(find_resolver "$stack_yaml")
# Resolver can point to a yaml file, so resolve this if need be.
if grep '\.yaml' <<< "$resolver" >/dev/null; then
  resolver=$(find_resolver "$resolver")
fi

url=https://www.stackage.org/$resolver

case $# in
  0) ;;
  1) url=$url/hoogle?q=$1;;
  *)
    >&2 echo "Unexpected argument: $2"
    exit 1
esac

"$OPEN" "$url"
